# ==========================
# Lab 4: OWASP Top 10 — Juice Shop (HTTP)
# Custom Suricata IDS/IPS rules
# ==========================

# --- A01: Broken Access Control (IDOR: /rest/basket/<id>) ---
alert http any any -> $HOME_NET 3000 (msg:"[IDS] IDOR basket access attempt"; flow:to_server,established; http_uri; pcre:"/\/rest\/basket\/\d+\//|\/rest\/basket\/\d+$"; classtype:web-application-attack; sid:4501001; rev:2;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] IDOR basket enumeration detected"; flow:to_server,established; http_uri; pcre:"/\/rest\/basket\/\d+\//|\/rest\/basket\/\d+$"; threshold:type both, track by_src, count 3, seconds 10; classtype:web-application-attack; sid:4501002; rev:2;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] IDOR basket enumeration blocked"; flow:to_server,established; http_uri; pcre:"/\/rest\/basket\/\d+\//|\/rest\/basket\/\d+$"; threshold:type both, track by_src, count 5, seconds 10; sid:4501101; rev:2;)

# --- A02: Cryptographic Failures (backup files, Poison Null Byte, coupons) ---
alert http any any -> $HOME_NET 3000 (msg:"[IDS] FTP directory access"; flow:to_server,established; http_uri; content:"/ftp/"; classtype:policy-violation; sid:4502001; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Backup file access attempt"; flow:to_server,established; http_uri; pcre:"/\.bak(\b|$)/i"; classtype:policy-violation; sid:4502002; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Poison Null Byte detected"; flow:to_server,established; http_uri; pcre:"/%00|%2500/i"; classtype:web-application-attack; sid:4502003; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Sensitive file access (coupons)"; flow:to_server,established; http_uri; content:"coupons"; nocase; classtype:policy-violation; sid:4502004; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] Poison Null Byte blocked"; flow:to_server,established; http_uri; pcre:"/%00|%2500/i"; sid:4502101; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] Backup file access blocked"; flow:to_server,established; http_uri; pcre:"/\.bak(\b|$)/i"; sid:4502102; rev:1;)

# --- A03: Injection (SQLi) ---
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SQLi OR 1=1 detected"; flow:to_server,established; http.request_body; pcre:"/or\s+1=1/i"; classtype:web-application-attack; sid:4503001; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SQLi UNION SELECT detected"; flow:to_server,established; http_uri; pcre:"/union\s+select/i"; classtype:web-application-attack; sid:4503002; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SQLi comment found"; flow:to_server,established; http.request_body; content:"--"; classtype:web-application-attack; sid:4503003; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] SQLi blocked on login"; flow:to_server,established; http_uri; content:"/rest/user/login"; http.method; content:"POST"; http.request_body; pcre:"/or\s+1=1|union\s+select/i"; sid:4503101; rev:1;)

# --- A04: Insecure Design (no rate limiting on login) ---
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Login brute-force (≥5 in 10s)"; flow:to_server,established; http_uri; content:"/rest/user/login"; http.method; content:"POST"; threshold:type both, track by_src, count 5, seconds 10; classtype:attempted-recon; sid:4504001; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Aggressive login brute-force (≥10 in 30s)"; flow:to_server,established; http_uri; content:"/rest/user/login"; threshold:type both, track by_src, count 10, seconds 30; classtype:attempted-recon; sid:4504002; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] Login brute-force blocked"; flow:to_server,established; http_uri; content:"/rest/user/login"; http.method; content:"POST"; threshold:type both, track by_src, count 5, seconds 10; sid:4504101; rev:1;)

# --- A05: Security Misconfiguration (directory listing, metrics, score-board) ---
alert http any any -> $HOME_NET 3000 (msg:"[IDS] FTP directory access"; flow:to_server,established; http_uri; content:"/ftp/"; classtype:policy-violation; sid:4505002; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Backup file access"; flow:to_server,established; http_uri; pcre:"/\.bak(\b|$)/i"; classtype:policy-violation; sid:4505003; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Metrics endpoint access"; flow:to_server,established; http_uri; content:"/metrics"; classtype:policy-violation; sid:4505004; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Security Questions API access"; flow:to_server,established; http_uri; content:"/api/SecurityQuestions"; classtype:policy-violation; sid:4505005; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Score Board access"; flow:to_server,established; http_uri; content:"/score-board"; classtype:policy-violation; sid:4505006; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] Metrics access blocked"; flow:to_server,established; http_uri; content:"/metrics"; sid:4505103; rev:1;)
drop  http !$HOME_NET any -> $HOME_NET 3000 (msg:"[IPS] External Score Board access blocked"; flow:to_server,established; http_uri; content:"/score-board"; sid:4505104; rev:1;)

# --- A06: Vulnerable and Outdated Components (fingerprinting) ---
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Error page fingerprinting attempt"; flow:to_server,established; http_uri; pcre:"/\.txt$|\.exe$|\.dll$|\.jsp$/i"; classtype:attempted-recon; sid:4506001; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Component version scan (403 burst)"; flow:to_server,established; http.stat_code; content:"403"; threshold:type both, track by_src, count 5, seconds 10; classtype:attempted-recon; sid:4506002; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Dependency config access"; flow:to_server,established; http_uri; pcre:"/package\.json|composer\.json|requirements\.txt/i"; classtype:attempted-recon; sid:4506003; rev:1;)

# --- A07: Identification & Authentication Failures ---
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SQLi auth bypass"; flow:to_server,established; http_uri; content:"/rest/user/login"; http.request_body; pcre:"/or\s+1=1/i"; classtype:web-application-attack; sid:4507001; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Multiple failed login attempts"; flow:to_server,established; http_uri; content:"/rest/user/login"; http.method; content:"POST"; threshold:type both, track by_src, count 5, seconds 30; classtype:attempted-recon; sid:4507002; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] User enumeration attempt"; flow:to_server,established; http_uri; content:"/rest/user/login"; threshold:type both, track by_src, count 10, seconds 60; classtype:attempted-recon; sid:4507003; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] SQLi auth bypass blocked"; flow:to_server,established; http_uri; content:"/rest/user/login"; http.request_body; pcre:"/or\s+1=1|union\s+select/i"; sid:4507101; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] Failed login threshold exceeded"; flow:to_server,established; http_uri; content:"/rest/user/login"; threshold:type both, track by_src, count 10, seconds 30; sid:4507102; rev:1;)

# --- A08: Software & Data Integrity Failures (XSS) ---
alert http any any -> $HOME_NET 3000 (msg:"[IDS] XSS script tag detected"; flow:to_server,established; http_uri; content:"<script"; nocase; classtype:web-application-attack; sid:4508001; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] XSS event handler detected"; flow:to_server,established; http_uri; pcre:"/on(load|error|click)\s*=/i"; classtype:web-application-attack; sid:4508002; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] XSS javascript: URI detected"; flow:to_server,established; http_uri; content:"javascript:"; nocase; classtype:web-application-attack; sid:4508003; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] XSS iframe injection detected"; flow:to_server,established; http_uri; content:"<iframe"; nocase; classtype:web-application-attack; sid:4508004; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] XSS img onerror detected"; flow:to_server,established; http_uri; content:"<img"; nocase; content:"onerror"; nocase; distance:50; classtype:web-application-attack; sid:4508005; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] XSS script blocked"; flow:to_server,established; http_uri; content:"<script"; nocase; sid:4508101; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] XSS javascript URI blocked"; flow:to_server,established; http_uri; content:"javascript:"; nocase; sid:4508102; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] XSS iframe blocked"; flow:to_server,established; http_uri; content:"<iframe"; nocase; sid:4508103; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] XSS event handler blocked"; flow:to_server,established; http_uri; pcre:"/on(load|error|click)\s*=/i"; sid:4508104; rev:1;)

# --- A09: Security Logging & Monitoring Failures (public logs) ---
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Log directory access"; flow:to_server,established; http_uri; content:"/support/logs"; classtype:policy-violation; sid:4509001; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Log file download"; flow:to_server,established; http_uri; pcre:"/support/logs/(access\.log|audit\.json)/"; classtype:policy-violation; sid:4509002; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] Multiple log file downloads"; flow:to_server,established; http_uri; content:"/support/logs/"; threshold:type both, track by_src, count 3, seconds 30; classtype:policy-violation; sid:4509003; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] Log access blocked"; flow:to_server,established; http_uri; content:"/support/logs"; sid:4509101; rev:1;)

# --- A10: SSRF (profile image URL fetch) ---
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SSRF AWS metadata attempt"; flow:to_server,established; http.request_body; content:"169.254.169.254"; classtype:web-application-attack; sid:4510001; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SSRF localhost targeting"; flow:to_server,established; http.request_body; pcre:"/(localhost|127\.0\.0\.1)/i"; classtype:web-application-attack; sid:4510002; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SSRF internal IP targeting"; flow:to_server,established; http.request_body; pcre:"/(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)/"; classtype:web-application-attack; sid:4510003; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SSRF via profile image URL endpoint"; flow:to_server,established; http_uri; content:"/profile/image/url"; http.method; content:"POST"; classtype:policy-violation; sid:4510004; rev:1;)
alert http any any -> $HOME_NET 3000 (msg:"[IDS] SSRF file:// protocol attempt"; flow:to_server,established; http.request_body; content:"file://"; nocase; classtype:web-application-attack; sid:4510005; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] SSRF AWS metadata blocked"; flow:to_server,established; http.request_body; content:"169.254.169.254"; sid:4510101; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] SSRF localhost blocked"; flow:to_server,established; http.request_body; pcre:"/(localhost|127\.0\.0\.1)/i"; sid:4510102; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] SSRF internal IP blocked"; flow:to_server,established; http.request_body; pcre:"/(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)/"; sid:4510103; rev:1;)
drop  http any any -> $HOME_NET 3000 (msg:"[IPS] SSRF file protocol blocked"; flow:to_server,established; http.request_body; content:"file://"; nocase; sid:4510104; rev:1;)

# End of Lab 4 rules
